name: Deploy to NetSuite

on:
  push:
    branches: [main]

defaults:
  run:
    working-directory: netsuite-github-integration

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install SuiteCloud CLI (accept license)
        run: npm install -g @oracle/suitecloud-cli --acceptsuitecloudsdklicense

      - name: Configure NetSuite Authentication
        run: |
          mkdir -p ~/.suitecloud
          cat <<EOF > ~/.suitecloud/config.json
{
  "defaultAuthId": "default",
  "auths": {
    "default": {
      "account": "${{ secrets.SDF_ACCOUNT_ID }}",
      "authType": "token",
      "tokenId": "${{ secrets.SDF_TOKEN_ID }}",
      "tokenSecret": "${{ secrets.SDF_TOKEN_SECRET }}",
      "consumerKey": "${{ secrets.SDF_CONSUMER_KEY }}",
      "consumerSecret": "${{ secrets.SDF_CONSUMER_SECRET }}"
    }
  }
}
EOF

      - name: Link Project to NetSuite
        run: |
          echo '{ "defaultAuthId": "default" }' > .suitecloudrc.json

      - name: Debug: Show auth + config files
        run: |
          echo ">>> .suitecloudrc.json:"
          cat .suitecloudrc.json
          echo ">>> config.json:"
          cat ~/.suitecloud/config.json
          suitecloud account:list

      - name: Deploy to NetSuite
        run: suitecloud project:deploy
