name: Deploy to NetSuite

on:
  push:
    branches: [main]

defaults:
  run:
    working-directory: netsuite-github-integration

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install SuiteCloud CLI
        run: npm install -g @oracle/suitecloud-cli --acceptsuitecloudsdklicense

      - name: Configure NetSuite Authentication
        run: |
          mkdir -p ~/.suitecloud
          echo '{' > ~/.suitecloud/config.json
          echo '  "defaultAuthId": "default",' >> ~/.suitecloud/config.json
          echo '  "auths": {' >> ~/.suitecloud/config.json
          echo '    "default": {' >> ~/.suitecloud/config.json
          echo '      "account": "'${{ secrets.SDF_ACCOUNT_ID }}'",' >> ~/.suitecloud/config.json
          echo '      "authType": "token",' >> ~/.suitecloud/config.json
          echo '      "tokenId": "'${{ secrets.SDF_TOKEN_ID }}'",' >> ~/.suitecloud/config.json
          echo '      "tokenSecret": "'${{ secrets.SDF_TOKEN_SECRET }}'",' >> ~/.suitecloud/config.json
          echo '      "consumerKey": "'${{ secrets.SDF_CONSUMER_KEY }}'",' >> ~/.suitecloud/config.json
          echo '      "consumerSecret": "'${{ secrets.SDF_CONSUMER_SECRET }}'"' >> ~/.suitecloud/config.json
          echo '    }' >> ~/.suitecloud/config.json
          echo '  }' >> ~/.suitecloud/config.json
          echo '}' >> ~/.suitecloud/config.json

      - name: Link Project to NetSuite
        run: echo '{ "defaultAuthId": "default" }' > .suitecloudrc.json

      - name: Debug: Show auth + config files
        run: |
          echo ">>> .suitecloudrc.json:"
          cat .suitecloudrc.json
          echo ">>> config.json:"
          cat ~/.suitecloud/config.json
          suitecloud account:list

      - name: Deploy to NetSuite
        run: suitecloud project:deploy
