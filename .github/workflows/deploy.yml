name: Deploy to NetSuite

on:
  push:
    branches: [main]

defaults:
  run:
    working-directory: netsuite-github-integration

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SDF_ACCOUNT_ID: ${{ secrets.SDF_ACCOUNT_ID }}
      SDF_CONSUMER_KEY: ${{ secrets.SDF_CONSUMER_KEY }}
      SDF_CONSUMER_SECRET: ${{ secrets.SDF_CONSUMER_SECRET }}
      SDF_TOKEN_ID: ${{ secrets.SDF_TOKEN_ID }}
      SDF_TOKEN_SECRET: ${{ secrets.SDF_TOKEN_SECRET }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install SuiteCloud CLI
        run: npm install -g @oracle/suitecloud-cli --acceptsuitecloudsdklicense

      - name: Configure NetSuite Authentication
        run: |
          mkdir -p ~/.suitecloud
          cat > ~/.suitecloud/config.json <<EOF
{
  "defaultAuthId": "default",
  "auths": {
    "default": {
      "account": "${SDF_ACCOUNT_ID}",
      "authType": "token",
      "tokenId": "${SDF_TOKEN_ID}",
      "tokenSecret": "${SDF_TOKEN_SECRET}",
      "consumerKey": "${SDF_CONSUMER_KEY}",
      "consumerSecret": "${SDF_CONSUMER_SECRET}"
    }
  }
}
EOF

      - name: Link Project to NetSuite
        run: echo '{ "defaultAuthId": "default" }' > .suitecloudrc.json

      - name: Debug: Show config files
        run: |
          echo ".suitecloudrc.json:"
          cat .suitecloudrc.json
          echo "config.json:"
          cat ~/.suitecloud/config.json
          suitecloud account:list

      - name: Deploy to NetSuite
        run: suitecloud project:deploy
